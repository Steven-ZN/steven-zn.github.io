name: Update Visitor Log

on:
  repository_dispatch:
    types: [visitor_log]
  
  # ä¹Ÿå¯ä»¥é€šè¿‡webhookè§¦å‘
  workflow_dispatch:
    inputs:
      visitor_data:
        description: 'Visitor data JSON'
        required: false
        default: '{}'

jobs:
  update-log:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Create visitor log entry
        run: |
          # åˆ›å»ºè®¿é—®è®°å½•
          echo "" >> visitor-log.txt
          echo "è®¿é—®æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> visitor-log.txt
          echo "è®¿é—®é¡µé¢: ${{ github.event.client_payload.url || 'Manual trigger' }}" >> visitor-log.txt
          echo "æ¥æº: ${{ github.event.client_payload.referrer || 'direct' }}" >> visitor-log.txt
          echo "è®¾å¤‡ä¿¡æ¯: ${{ github.event.client_payload.screen || 'unknown' }}" >> visitor-log.txt
          echo "æµè§ˆå™¨: ${{ github.event.client_payload.userAgent || 'unknown' }}" | head -c 100 >> visitor-log.txt
          echo "" >> visitor-log.txt
          echo "IPåœ°å€: ${{ github.event.client_payload.ip || 'unknown' }}" >> visitor-log.txt
          echo "ä½ç½®: ${{ github.event.client_payload.city || 'unknown' }}, ${{ github.event.client_payload.country || 'unknown' }}" >> visitor-log.txt
          echo "è¯­è¨€: ${{ github.event.client_payload.language || 'unknown' }}" >> visitor-log.txt
          echo "æ—¶åŒº: ${{ github.event.client_payload.timezone || 'unknown' }}" >> visitor-log.txt
          echo "===============================================" >> visitor-log.txt
          
      - name: Commit and push changes
        run: |
          git config --local user.email "visitor-log@github.com"
          git config --local user.name "Visitor Log Bot"
          git add visitor-log.txt
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“Š Visitor log update - $(date '+%Y-%m-%d %H:%M:%S')"
            git push
          fi